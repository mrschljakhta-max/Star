<!doctype html>
<html lang="uk" data-scene="warm">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLSL + Clean Navbar + Dropdown + Explore + Shapes + Modal</title>

  <style>
    :root{
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.74);
      --line: rgba(255,255,255,0.12);

      --accent: rgba(255,220,160,0.90);
      --accentSoft: rgba(255,220,160,0.22);
      --accentGlow: rgba(255,170,90,0.35);
      --accentText: rgba(255,235,200,0.95);
    }

    html[data-scene="warm"]{
      --accent: rgba(255,220,160,0.90);
      --accentSoft: rgba(255,220,160,0.22);
      --accentGlow: rgba(255,170,90,0.35);
      --accentText: rgba(255,235,200,0.95);
    }
    html[data-scene="night"]{
      --accent: rgba(185,150,255,0.92);
      --accentSoft: rgba(185,150,255,0.22);
      --accentGlow: rgba(150,120,255,0.35);
      --accentText: rgba(230,220,255,0.95);
    }
    html[data-scene="cold"]{
      --accent: rgba(140,245,255,0.95);
      --accentSoft: rgba(140,245,255,0.22);
      --accentGlow: rgba(80,210,255,0.35);
      --accentText: rgba(215,255,255,0.95);
    }

    html,body{margin:0;padding:0;height:100%;background:#000;}
    body{
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
    }

    /* ===== WebGL ===== */
    #glcanvas{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      display:block;
      z-index:0;
      image-rendering: auto;
    }

    .overlay{
      position:fixed; inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(80% 60% at 50% 40%, rgba(0,0,0,0.00), rgba(0,0,0,0.72)),
        linear-gradient(180deg, rgba(0,0,0,0.20), rgba(0,0,0,0.60));
    }

    .grain{
      position:fixed;
      inset:-20%;
      z-index:6;
      pointer-events:none;
      opacity:0.22;
      mix-blend-mode: overlay;
      filter: contrast(120%) brightness(105%);
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.07), rgba(255,255,255,0) 35%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.06), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.05), rgba(255,255,255,0) 45%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.025), rgba(255,255,255,0.025) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 3px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 3px);
      animation: grainMove 6s steps(8) infinite;
    }
    @keyframes grainMove{
      0%{ transform: translate3d(-2%, -2%, 0) rotate(0deg); }
      25%{ transform: translate3d(2%, -1%, 0) rotate(1deg); }
      50%{ transform: translate3d(1%, 2%, 0) rotate(-1deg); }
      75%{ transform: translate3d(-1%, 1%, 0) rotate(0.5deg); }
      100%{ transform: translate3d(-2%, -2%, 0) rotate(0deg); }
    }

    /* ===== Navbar layout: left / center / right ===== */
    header{
      position:fixed; top:0; left:0; right:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: rgba(0,0,0,0.30);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .nav{
      width:min(1200px, 94vw);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      padding: 14px 0;
      gap: 10px;
    }

    .navLeft{ justify-self:start; position:relative; }
    .navCenter{ justify-self:center; }
    .navRight{ justify-self:end; display:flex; gap:10px; align-items:center; }

    .navLinks{
      display:flex;
      gap: 22px;
      align-items:center;
      font-weight: 800;
      opacity:.92;
    }
    .navLinks a{
      color: rgba(255,255,255,0.78);
      text-decoration:none;
    }
    .navLinks a:hover{ color: rgba(255,255,255,0.95); }

    /* Premium buttons */
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 10px 16px;
      border-radius: 16px;
      font-weight: 900;
      letter-spacing: .02em;
      cursor:pointer;
      position:relative;
      transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease, opacity .25s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.09); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0) scale(0.98); }

    .btn.premium{
      border-color: color-mix(in srgb, var(--accentSoft), rgba(255,255,255,0.10));
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.04) inset,
        0 10px 30px rgba(0,0,0,0.45),
        0 0 24px var(--accentGlow);
    }
    .btn.premium::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 18px;
      background: radial-gradient(60% 120% at 20% 20%, var(--accentSoft), rgba(0,0,0,0) 55%);
      opacity:.75;
      pointer-events:none;
      filter: blur(0.2px);
    }
    .btn.pulse{ animation: btnPulse 2.2s ease-in-out infinite; }
    @keyframes btnPulse{
      0%,100%{ box-shadow: 0 0 0 1px rgba(255,255,255,0.04) inset, 0 10px 30px rgba(0,0,0,0.45), 0 0 18px var(--accentGlow); }
      50%{ box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 14px 38px rgba(0,0,0,0.55), 0 0 32px var(--accentGlow); }
    }
    .btnHidden{ opacity:0; transform: translateY(-4px); pointer-events:none; }
    .btnVisible{ opacity:1; transform: translateY(0); pointer-events:auto; }

    /* ===== Dropdown popover (DOWN) ===== */
    .popover{
      position:absolute;
      top: calc(100% + 12px);
      left: 0;               /* aligned to left edge of Background button */
      width: 340px;
      border-radius: 18px;
      background: rgba(0,0,0,0.62);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(14px);
      box-shadow: 0 24px 70px rgba(0,0,0,0.60);
      padding: 14px 14px 12px;

      opacity:0;
      visibility:hidden;
      pointer-events:none;
      transform: translateY(-6px);
      transition: opacity .18s ease, transform .18s ease, visibility .18s ease;
    }
    .popover.open{
      opacity:1;
      visibility:visible;
      pointer-events:auto;
      transform: translateY(0);
    }

    .popTitle{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 10px;
    }
    .popTitle strong{ letter-spacing:.02em; }
    .xBtn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
      border-radius: 12px;
      padding: 6px 9px;
      cursor:pointer;
      font-weight:900;
    }

    .row{ display:flex; align-items:center; gap: 10px; margin: 10px 0 8px; }
    .row label{ width: 88px; color: rgba(255,255,255,0.72); font-size: 13px; }

    select, input[type="range"]{ width: 100%; }

    select{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: #fff;
      outline: none;
    }
    select:focus{
      border-color: var(--accentSoft);
      box-shadow: 0 0 0 3px var(--accentSoft);
    }

    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      outline:none;
      border: 1px solid rgba(255,255,255,0.08);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: rgba(255,255,255,0.92);
      border: 2px solid var(--accentSoft);
      box-shadow: 0 0 18px var(--accentGlow);
      cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px; height: 18px;
      border-radius: 50%;
      background: rgba(255,255,255,0.92);
      border: 2px solid var(--accentSoft);
      box-shadow: 0 0 18px var(--accentGlow);
      cursor:pointer;
    }

    .popHint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(200,210,255,0.88);
      opacity:.9;
    }

    /* ===== Stage + symbols ===== */
    .stage{
      position:fixed; inset:0;
      z-index:10;
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .symbols{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: clamp(22px, 5vw, 52px);
      transform: translateY(-18px);
      opacity:0;
      visibility:hidden;
      transition: opacity .25s ease, visibility .25s ease;
      pointer-events:none;
    }
    .symbols.active{
      opacity:1;
      visibility:visible;
      pointer-events:auto;
    }

    .symbolBtn{
      width: 120px;
      height: 120px;
      position:relative;
      cursor:pointer;
      pointer-events:auto;
      display:grid;
      place-items:center;
      user-select:none;

      opacity:0;
      transform: translateY(18px) scale(0.92);
      filter: blur(8px);
    }
    .symbolBtn.show{ animation: popIn .65s cubic-bezier(.2,.9,.2,1) forwards; }
    @keyframes popIn{
      to{ opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
    }

    .symbolBtn::before{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius: 28px;
      background: radial-gradient(60% 60% at 50% 50%, var(--accentSoft), rgba(0,0,0,0) 70%);
      opacity:.8;
      filter: blur(2px);
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .symbolBtn:hover::before{ opacity:1; }

    .shape{
      width: 74px;
      height: 74px;
      transition: transform .18s ease, filter .18s ease;
      filter: drop-shadow(0 0 16px var(--accentGlow));
    }
    .symbolBtn:hover .shape{
      transform: scale(0.82);
      filter: drop-shadow(0 0 26px var(--accentGlow));
    }

    .label{
      position:absolute;
      bottom: -10px;
      transform: translateY(12px);
      opacity:0;
      font-weight:900;
      letter-spacing:.02em;
      color: var(--accentText);
      text-shadow: 0 0 14px rgba(0,0,0,0.55);
      transition: opacity .18s ease, transform .18s ease;
      font-size: 14px;
      white-space:nowrap;
    }
    .symbolBtn:hover .label{
      opacity:1;
      transform: translateY(0);
    }

    .circle{
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.16);
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,0.28), rgba(0,0,0,0) 55%),
        radial-gradient(circle at 60% 65%, var(--accentSoft), rgba(0,0,0,0) 62%);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }
    .square{
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.16);
      background:
        linear-gradient(135deg, rgba(255,255,255,0.12), rgba(0,0,0,0.0)),
        radial-gradient(circle at 55% 45%, var(--accentSoft), rgba(0,0,0,0) 62%);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }
    .triangle{
      width:0; height:0;
      border-left: 40px solid transparent;
      border-right: 40px solid transparent;
      border-bottom: 72px solid rgba(255,255,255,0.16);
      position:relative;
      filter: drop-shadow(0 0 16px var(--accentGlow));
    }
    .triangle::after{
      content:"";
      position:absolute;
      left:-36px;
      top:8px;
      width:0; height:0;
      border-left: 36px solid transparent;
      border-right: 36px solid transparent;
      border-bottom: 64px solid rgba(0,0,0,0.55);
    }
    .triangle::before{
      content:"";
      position:absolute;
      left:-30px;
      top:16px;
      width:0; height:0;
      border-left: 30px solid transparent;
      border-right: 30px solid transparent;
      border-bottom: 52px solid color-mix(in srgb, var(--accentSoft), rgba(255,255,255,0.10));
      opacity:.95;
    }

    /* ===== Modal ===== */
    .modalOverlay{
      position:fixed; inset:0;
      z-index:80;
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.48);
      backdrop-filter: blur(8px);
      opacity:0; visibility:hidden; pointer-events:none;
      transition: opacity .18s ease, visibility .18s ease;
    }
    .modalOverlay.open{ opacity:1; visibility:visible; pointer-events:auto; }

    .modal{
      width: min(640px, 92vw);
      border-radius: 20px;
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 30px 90px rgba(0,0,0,0.70), 0 0 36px var(--accentGlow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      transform: translateY(10px) scale(0.98);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .modalOverlay.open .modal{ transform: translateY(0) scale(1); opacity:1; }

    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: radial-gradient(80% 140% at 10% 20%, var(--accentSoft), rgba(0,0,0,0) 60%);
    }
    .modalHead strong{ letter-spacing:.02em; }
    .modalClose{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modalBody{ padding: 16px; color: rgba(255,255,255,0.82); line-height:1.7; }
    .modalTag{
      display:inline-block;
      margin-top: 10px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--accentText);
      font-weight:900;
      font-size: 13px;
    }

    @media (max-width: 860px){
      .nav{ grid-template-columns: auto 1fr auto; }
      .navLinks{ gap: 14px; font-size: 14px; }
      .popover{ width: 320px; }
      .symbols{ flex-direction:column; transform: translateY(-8px); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <canvas id="glcanvas"></canvas>
  <div class="overlay"></div>
  <div class="grain" id="grain"></div>

  <header>
    <div class="nav">
      <!-- LEFT: Background -->
      <div class="navLeft">
        <button id="btnBackground" class="btn premium" type="button" aria-haspopup="dialog" aria-expanded="false">
          Background
        </button>

        <div id="bgPopover" class="popover" role="dialog" aria-label="Background controls">
          <div class="popTitle">
            <strong>GLSL Background</strong>
            <button class="xBtn" id="bgClose" type="button">×</button>
          </div>

          <div class="row">
            <label>Scene</label>
            <select id="scene">
              <option value="warm">Warm</option>
              <option value="night">Night</option>
              <option value="cold">Cold</option>
            </select>
          </div>

          <div class="row">
            <label>Speed</label>
            <input id="speed" type="range" min="0" max="4" step="0.01" value="1" />
          </div>

          <div class="row">
            <label>Intensity</label>
            <input id="intensity" type="range" min="0" max="2" step="0.01" value="1" />
          </div>

          <div class="row">
            <label>Grain</label>
            <input id="grainAmt" type="range" min="0" max="0.6" step="0.01" value="0.22" />
          </div>

          <div class="popHint">Мишка → реакція. Scene → інший настрій.</div>
        </div>
      </div>

      <!-- CENTER: Links -->
      <div class="navCenter">
        <nav class="navLinks" aria-label="Top navigation">
          <a href="#about" onclick="return false;">About</a>
          <a href="#projects" onclick="return false;">Projects</a>
          <a href="#contact" onclick="return false;">Contact</a>
        </nav>
      </div>

      <!-- RIGHT: Explore / Back -->
      <div class="navRight">
        <button id="btnExplore" class="btn premium pulse btnHidden" type="button">Explore</button>
        <button id="btnBack" class="btn premium btnHidden" type="button">Back/Close</button>
      </div>
    </div>
  </header>

  <!-- Stage -->
  <div class="stage">
    <div id="symbols" class="symbols" aria-label="Projects symbols">
      <div class="symbolBtn" data-key="dashboard" role="button" aria-label="Dashboard">
        <div class="shape circle"></div>
        <div class="label">Dashboard</div>
      </div>

      <div class="symbolBtn" data-key="animated" role="button" aria-label="Animated Website">
        <div class="shape triangle"></div>
        <div class="label">Animated Website</div>
      </div>

      <div class="symbolBtn" data-key="interactive" role="button" aria-label="Interactive">
        <div class="shape square"></div>
        <div class="label">Interactive</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Details">
      <div class="modalHead">
        <strong id="modalTitle">Title</strong>
        <button id="modalClose" class="modalClose" type="button">×</button>
      </div>
      <div class="modalBody">
        <div id="modalText">Text</div>
        <div id="modalTag" class="modalTag">Tag</div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const html = document.documentElement;

      // UI
      const btnBackground = document.getElementById("btnBackground");
      const bgPopover = document.getElementById("bgPopover");
      const bgClose = document.getElementById("bgClose");

      const btnExplore = document.getElementById("btnExplore");
      const btnBack = document.getElementById("btnBack");

      const symbols = document.getElementById("symbols");
      const symbolBtns = Array.from(document.querySelectorAll(".symbolBtn"));

      const sceneEl = document.getElementById("scene");
      const speedEl = document.getElementById("speed");
      const intensityEl = document.getElementById("intensity");
      const grainAmtEl = document.getElementById("grainAmt");
      const grain = document.getElementById("grain");

      // Modal
      const modalOverlay = document.getElementById("modalOverlay");
      const modalTitle = document.getElementById("modalTitle");
      const modalText = document.getElementById("modalText");
      const modalTag = document.getElementById("modalTag");
      const modalClose = document.getElementById("modalClose");

      const content = {
        dashboard: {
          title: "Dashboard",
          text: "Excel/VBA, аналітика, автоматизація, звіти. Фокус: швидкість, точність, зручність для реального використання.",
          tag: "Excel • VBA • Analytics"
        },
        animated: {
          title: "Animated Website",
          text: "GSAP/Scroll-ефекти, мікроінтеракції, вау-переходи. Фокус: відчуття “дорогого” UI та плавна анімація.",
          tag: "Motion • UI • GSAP"
        },
        interactive: {
          title: "Interactive",
          text: "Міні-ігри, демки, тренажери, прототипи. Фокус: залучення, механіки, експерименти з UX.",
          tag: "Games • Demos • UX"
        }
      };

      function openModal(key){
        const c = content[key];
        if (!c) return;
        modalTitle.textContent = c.title;
        modalText.textContent = c.text;
        modalTag.textContent = c.tag;
        modalOverlay.classList.add("open");
        modalOverlay.setAttribute("aria-hidden", "false");
      }
      function closeModal(){
        modalOverlay.classList.remove("open");
        modalOverlay.setAttribute("aria-hidden", "true");
      }

      modalClose.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });

      symbolBtns.forEach(btn => btn.addEventListener("click", () => openModal(btn.dataset.key)));

      // Dropdown down
      function openPopover(){
        bgPopover.classList.add("open");
        btnBackground.setAttribute("aria-expanded", "true");
      }
      function closePopover(){
        bgPopover.classList.remove("open");
        btnBackground.setAttribute("aria-expanded", "false");
      }

      btnBackground.addEventListener("click", (e) => {
        e.stopPropagation();
        bgPopover.classList.contains("open") ? closePopover() : openPopover();
      });
      bgClose.addEventListener("click", (e) => { e.stopPropagation(); closePopover(); });
      bgPopover.addEventListener("click", (e) => e.stopPropagation());
      window.addEventListener("click", () => closePopover());

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closePopover();
          closeModal();
        }
      });

      // Grain
      function applyGrain(){ grain.style.opacity = String(parseFloat(grainAmtEl.value)); }
      grainAmtEl.addEventListener("input", applyGrain);
      applyGrain();

      // Explore appears after 3 significant mouse moves
      let moves = 0;
      let lastX = null, lastY = null;
      const MOVE_THRESHOLD = 20;
      let exploreReady = false;
      let exploring = false;

      function setExploreVisible(v){
        btnExplore.classList.toggle("btnVisible", v);
        btnExplore.classList.toggle("btnHidden", !v);
      }
      function setBackVisible(v){
        btnBack.classList.toggle("btnVisible", v);
        btnBack.classList.toggle("btnHidden", !v);
      }
      setExploreVisible(false);
      setBackVisible(false);

      function resetExploreGate(){
        moves = 0; lastX = null; lastY = null;
        exploreReady = false;
        setExploreVisible(false);
      }

      const isCoarse = matchMedia("(pointer: coarse)").matches;
      if (isCoarse) {
        exploreReady = true;
        setExploreVisible(true);
      } else {
        window.addEventListener("pointermove", (e) => {
          if (exploreReady || exploring) return;
          if (lastX === null) { lastX = e.clientX; lastY = e.clientY; return; }
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist >= MOVE_THRESHOLD) {
            moves++;
            lastX = e.clientX; lastY = e.clientY;
            if (moves >= 3) {
              exploreReady = true;
              setExploreVisible(true);
            }
          }
        }, { passive:true });
      }

      // Symbols
      function showSymbolsSequence(){
        exploring = true;
        setExploreVisible(false);
        setBackVisible(true);

        symbols.classList.add("active");
        symbolBtns.forEach(b => b.classList.remove("show"));
        symbolBtns.forEach((b, i) => setTimeout(() => b.classList.add("show"), 250 + i * 260));
      }

      function hideSymbolsAndReset(){
        closeModal();
        symbols.classList.remove("active");
        symbolBtns.forEach(b => b.classList.remove("show"));
        setBackVisible(false);

        exploring = false;
        resetExploreGate();
        if (isCoarse) { exploreReady = true; setExploreVisible(true); }
      }

      btnExplore.addEventListener("click", () => {
        btnExplore.classList.remove("pulse");
        setTimeout(() => btnExplore.classList.add("pulse"), 600);
        showSymbolsSequence();
      });
      btnBack.addEventListener("click", hideSymbolsAndReset);

      // ===== WebGL with better quality (DPR clamp) =====
      const canvas = document.getElementById("glcanvas");
      const gl = canvas.getContext("webgl", { antialias:false, alpha:false, depth:false, stencil:false });
      if (!gl) return;

      const mouse = { x: 0.5, y: 0.5 };
      window.addEventListener("pointermove", (e) => {
        mouse.x = Math.min(1, Math.max(0, e.clientX / innerWidth));
        mouse.y = Math.min(1, Math.max(0, e.clientY / innerHeight));
      }, { passive:true });

      let u_res, u_time, u_speed, u_intensity, u_mouse, u_scene;

      function sceneToId(v){
        if (v === "warm") return 0.0;
        if (v === "night") return 1.0;
        return 2.0;
      }

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // quality/perf sweet spot
        canvas.width  = Math.floor(window.innerWidth  * dpr);
        canvas.height = Math.floor(window.innerHeight * dpr);
        gl.viewport(0, 0, canvas.width, canvas.height);
        if (u_res) gl.uniform2f(u_res, canvas.width, canvas.height);
      }
      window.addEventListener("resize", resize);

      const vert = `
        attribute vec2 pos;
        void main(){ gl_Position = vec4(pos,0.0,1.0); }
      `;

      const frag = `
        #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
        #else
        precision mediump float;
        #endif

        uniform vec2 u_res;
        uniform float u_time;
        uniform float u_speed;
        uniform float u_intensity;
        uniform vec2 u_mouse;
        uniform float u_scene;

        vec3 palette(float sceneId, float k) {
          vec3 warmA = vec3(1.00, 0.62, 0.28);
          vec3 warmB = vec3(0.28, 0.24, 0.20);

          vec3 nightA = vec3(0.62, 0.35, 1.00);
          vec3 nightB = vec3(0.05, 0.08, 0.18);

          vec3 coldA = vec3(0.35, 0.95, 1.00);
          vec3 coldB = vec3(0.08, 0.14, 0.18);

          if (sceneId < 0.5) return mix(warmB, warmA, k);
          if (sceneId < 1.5) return mix(nightB, nightA, k);
          return mix(coldB, coldA, k);
        }

        void main(){
          vec2 FC = gl_FragCoord.xy;
          float t = u_time * u_speed;

          vec2 r = u_res;
          vec2 p = (FC*2.0 - r) / r.y;

          vec2 m = u_mouse*2.0 - 1.0;
          float md = length(p - m);

          float inten = max(0.0, u_intensity);

          vec2 center = mix(vec2(0.0), m, 0.35);
          vec2 pp = p - center;

          vec3 c = vec3(0.0);

          for (float i=0.0; i<42.0; i++){
            float a = i/1.5 + t*0.5;
            vec2 q = pp;

            float wobble = (0.8 + 1.2*inten) * (0.6 + 0.4*smoothstep(0.8, 0.0, md));
            q.x = q.x + sin(q.y*19.0 + t*2.0 + i) * 29.0 * smoothstep(0.0, -2.0, q.y) * wobble;

            float orbit = 0.4 * smoothstep(0.0, 0.5, -q.y);
            vec2 orb = vec2(cos(a), sin(a)) * orbit;

            float d = max(length(q-orb), 0.002);

            float k = fract(i*0.21);
            vec3 base = palette(u_scene, k);

            c += base * (0.015 / d);
          }

          vec3 col = c*c + 0.05;

          float v = smoothstep(1.35, 0.2, length(p));
          float glow = smoothstep(0.45, 0.0, md) * 0.25 * (0.6 + 0.8*inten);

          col *= (0.65 + 0.35*v);
          col += glow * palette(u_scene, 1.0);

          col = clamp(col, 0.0, 1.0);
          gl_FragColor = vec4(col, 1.0);
        }
      `;

      function compile(src, type){
        const s = gl.createShader(type);
        gl.shaderSource(s, src);
        gl.compileShader(s);
        if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s) || "compile failed");
        return s;
      }
      function link(vs, fs){
        const p = gl.createProgram();
        gl.attachShader(p, vs);
        gl.attachShader(p, fs);
        gl.bindAttribLocation(p, 0, "pos");
        gl.linkProgram(p);
        if (!gl.getProgramParameter(p, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(p) || "link failed");
        return p;
      }

      let program;
      try{
        const vs = compile(vert, gl.VERTEX_SHADER);
        const fs = compile(frag, gl.FRAGMENT_SHADER);
        program = link(vs, fs);
      }catch(e){
        console.error(e);
        return;
      }

      gl.useProgram(program);

      const buf = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buf);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 3,-1, -1,3]), gl.STATIC_DRAW);

      gl.enableVertexAttribArray(0);
      gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

      u_res = gl.getUniformLocation(program, "u_res");
      u_time = gl.getUniformLocation(program, "u_time");
      u_speed = gl.getUniformLocation(program, "u_speed");
      u_intensity = gl.getUniformLocation(program, "u_intensity");
      u_mouse = gl.getUniformLocation(program, "u_mouse");
      u_scene = gl.getUniformLocation(program, "u_scene");

      resize();

      gl.uniform1f(u_speed, parseFloat(speedEl.value));
      gl.uniform1f(u_intensity, parseFloat(intensityEl.value));
      gl.uniform2f(u_mouse, mouse.x, mouse.y);
      gl.uniform1f(u_scene, sceneToId(sceneEl.value));
      gl.uniform2f(u_res, canvas.width, canvas.height);

      speedEl.addEventListener("input", () => gl.uniform1f(u_speed, parseFloat(speedEl.value)));
      intensityEl.addEventListener("input", () => gl.uniform1f(u_intensity, parseFloat(intensityEl.value)));

      sceneEl.addEventListener("change", () => {
        html.dataset.scene = sceneEl.value;
        gl.uniform1f(u_scene, sceneToId(sceneEl.value));
      });

      let start = performance.now();
      let raf = null;
      let pausedAt = 0;

      function draw(){
        const now = performance.now();
        const t = (now - start) * 0.001;

        gl.uniform1f(u_time, t);
        gl.uniform2f(u_mouse, mouse.x, mouse.y);
        gl.drawArrays(gl.TRIANGLES, 0, 3);

        raf = requestAnimationFrame(draw);
      }

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          if (raf) cancelAnimationFrame(raf);
          raf = null;
          pausedAt = performance.now();
        } else {
          const resumeAt = performance.now();
          start += (resumeAt - pausedAt);
          if (!raf) draw();
        }
      });

      draw();
    })();
  </script>
</body>
</html>
